---
title: "SAE Project"
author: "Group 3"
date: "`r Sys.Date()`"
output: html_document
---

```{r, message=FALSE}
# Packages
library(haven)
library(dplyr)
library(readxl)
library(sae)
```

```{r}
# Dataset
data_final <- read_sav("data_final.sav")          # Main Dataset
          
data <- read_sav("KOR23GAB_saeProject.sav")     # Predictor Dataset

PODES21_auxvar_1 <- read_sav("PODES21_auxvar_1.sav")       # Podes Dataset 1
PODES21_auxvar_2 <- read_sav("PODES21_auxvar_2.sav")       # Podes Dataset 2
PODES21_auxvar_3 <- read_sav("PODES21_auxvar_3.sav")       # Podes Dataset 3
PODES21_auxvar_4 <- read_sav("PODES21_auxvar_4.sav")       # Podes Dataset 4

```

```{r}
# Eksplorasi
clean <- data %>%
  filter(R407 >= 7 & R407 <= 17) %>%
  mutate(KODE = paste0(R101,R102)) %>%
  mutate(DISAB = ifelse((R1002 == 1 | R1002 == 2) |
                        (R1003 == 5 | R1003 == 6) | 
                        (R1004 == 1 | R1004 == 2) |
                        (R1005 == 5 | R1005 == 6) |
                        (R1006 == 1 | R1006 == 2) |
                        (R1007 == 5 | R1007 == 6) |
                        (R1008 == 1 | R1008 == 2) |
                        (R1009 == 5 | R1009 == 6), 1, 0)) %>%
  mutate(SEKUL = ifelse(R610 == 2, 1, 0)) %>%
  mutate(DISAB_SEKUL = ifelse(DISAB == 1 & SEKUL == 1, 1, 0)) %>%
  mutate(DISAB_NON_SEKUL = ifelse(DISAB == 1 & SEKUL == 0, 1, 0)) %>%
  mutate(NON_DISAB_SEKUL = ifelse(DISAB == 0 & SEKUL == 1, 1, 0)) %>%
  mutate(NON_DISAB_NON_SEKUL = ifelse(DISAB == 0 & SEKUL == 0, 1, 0)) %>%
  select(c(KODE,DISAB,SEKUL,DISAB_SEKUL,DISAB_NON_SEKUL,NON_DISAB_SEKUL,NON_DISAB_NON_SEKUL))

clean <- clean %>%
  group_by(KODE) %>%
  summarise(
    jumlah_sampel = sum(DISAB),
    jumlah_sampel_disab = sum(DISAB == 1),
    jumlah_sampel_tidak = sum(DISAB == 0),
    jumlah_sekolah = sum(SEKUL),
    jumlah_sekolah_disab = sum(DISAB_SEKUL == 1),
    jumlah_sekolah_tidak = sum(NON_DISAB_SEKUL == 1)
  )
```

```{r}
data1 <- PODES21_auxvar_1 %>%
  rename(Kabupaten = r102n) %>%
  group_by(Kabupaten) %>%
  summarise(jumlah_deskel = n(),
            permukiman_kumuh = sum(r512a == 1),
            desa_dalam_hutan = sum(r309a == 1),      
            desa_tepi_hutan = sum(r309a == 2),
            desa_luar_hutan = sum(r309a == 3),
            desa_ketinggian_lebih_200 = sum(r307b2 >= 200),
            desa_ketinggian_kurang_200 = sum(r307b2 < 200),
            desa_penerangan_jalan = sum(r502b == 1| r502b == 2),
            desa_tanpa_penerangan_jalan = sum(r502b == 3),
            penghasilan_utama_pertanian = sum(r403a == 1),
            desa_airminum_bukan_kemasan = sum(r507a == 3| r507a == 4| r507a == 5|
                                              r507a == 6| r507a == 7| r507a == 8|
                                              r507a == 9| r507a == 10),
            keluarga_bukan_listrik = sum(r501b),
            )

data2 <- PODES21_auxvar_2 %>%
  rename(Kabupaten = r102n) %>%
  group_by(Kabupaten) %>%
  summarise(jumlah_SKTM = sum(r711),
            jumlah_sarana_kesehatan = sum(r704ak2|r704bk2|r704ck2|r704dk2|r704ek2|
                                          r704fk2|r704gk2|r704hk2|r704ik2|r704lk2|
                                          r704mk2),
            jumlah_faskes_lain = sum(r704bk2|r704ck2|r704dk2|r704ek2|
                                     r704fk2|r704gk2|r704hk2|r704ik2|
                                     r704jk2|r704kk2|r704lk2|r704mk2),
            jumlah_tenaga_kesehatan = sum(r706a1|r706a2|r706b|r706c|r706d),
            jumlah_faskes = sum(r704ak2|r704bk2|r704ck2|r704dk2|
                                r704ek2|r704fk2|r704gk2|r704hk2|
                                r704ik2|r704jk2|r704kk2|r704lk2|r704mk2),
            jumlah_warga_kekurangan_gizi = sum(r710)
            )

data3 <- PODES21_auxvar_3 %>%
  rename(Kabupaten = r102n) %>%
  group_by(Kabupaten) %>%
  summarise(jumlah_desa_sinyal_kuat = sum(r1005c == 1|r1005c == 2),
            jumlah_desa_sinyal_4G = sum(r1005c == 1),
            jumlah_desa_sebagian_besar_ponsel = sum(r1003b == 1),
            jumlah_desa_sebagian_kecil_ponsel = sum(r1003b == 2),
            jumlah_desa_tidak_ada_ponsel = sum(r1003b == 3),
            jumlah_desa_lalu_lintas_darat = sum(r1001a == 1),
            jumlah_desa_lalu_lintas_lainnya = sum(r1001a == 2|r1001a == 3|r1001a == 4),
            jumlah_desa_aspal = sum(r1001b1 == 1),
            jumlah_desa_angkutan_umum = sum(r1001c1 == 1 | r1001c1 == 2),
            jumlah_koperasi_simpan_pinjam = sum(r1206a3),
            jumlah_koperasi_lainnya = sum(r1206a4)
            )

data4 <- PODES21_auxvar_4 %>%
  rename(Kabupaten = r102n) %>%
  group_by(Kabupaten) %>%
  summarise(jumlah_korban_bunuh_diri = sum(r1307ak2|r1307ak3)
  )

```


```{r}
# Merge Dataset Podes
data_merge <- full_join(data1, data2, by = "Kabupaten")
data_merge <- full_join(data_merge, data3, by = "Kabupaten")
data_merge <- full_join(data_merge, data4, by = "Kabupaten")
data_merge <- full_join(data_final, data_merge, by = "Kabupaten")

```


```{r}
data_olah <- data_merge %>%
  mutate(
    jumlah_desa_aspal = ifelse(is.na(jumlah_desa_aspal),0,jumlah_desa_aspal),
    persen_perkotaan = (jumlah_kota/jumlah_deskel)*100,
    persen_perdesaan = (jumlah_desa/jumlah_deskel)*100,
    persen_kumuh = (permukiman_kumuh/jumlah_deskel)*100,
    Persen_desa_dalam_hutan = (desa_dalam_hutan/jumlah_deskel)*100,
    Persen_desa_tepi_hutan = (desa_tepi_hutan/jumlah_deskel)*100,
    Persen_desa_luar_hutan = (desa_luar_hutan/jumlah_deskel)*100,
    Persen_desa_ketinggian_lebih_200 = (desa_ketinggian_lebih_200/jumlah_deskel)*100,
    Persen_desa_ketinggian_kurang_200 = (desa_ketinggian_kurang_200/jumlah_deskel)*100,
    Rasio_bts_luas = jumlah_menara_bts/luas_wilayah,
    Rasio_murid_sd = murid_sd/jumlah_sd,
    Rasio_murid_smp = murid_smp/jumlah_smp,
    Rasio_murid_sma = murid_sma/jumlah_sma,
    Rasio_murid_slb = murid_slb/jumlah_slb,
    Rasio_nakes_faskes = jumlah_tenaga_kesehatan/jumlah_faskes,
    Rasio_aspal_darat = jumlah_desa_aspal/jumlah_desa_lalu_lintas_darat,
    Rasio_angkutan_umum_darat = jumlah_desa_angkutan_umum/jumlah_desa_lalu_lintas_darat,
    Rasio_simpan_pinjam_lainnya = jumlah_koperasi_simpan_pinjam/jumlah_koperasi_lainnya
  )

data_olah
```


```{r}
# Membuat dataset khusus pengolahan
data_olahan <- data_olah[,-c(1,2,3,6)]
```

```{r}
# Cek Korelasi

# Membuat data frame kosong
results <- data.frame(Variable = character(),
                      Correlation = numeric(),
                      Cutoff = character(),
                      P_Value = numeric(),
                      Decision = character(),
                      stringsAsFactors = FALSE)

# Melakukan iterasi untuk setiap kolom dalam data_olahan
for (i in 1:(ncol(data_olahan)-1)) {
  # Menghitung uji korelasi
  a <- cor.test(x = data_olahan[[i]], y = data_olahan$APS_Disab, method = "pearson")
  
  # Menentukan keputusan berdasarkan p-value
  cutoff <- ifelse(abs(a$estimate) >= 0.5, "Korelasi >= 0,5", 
                     ifelse(abs(a$estimate) >= 0.3,"Korelasi >= 0,3",
                            ifelse(abs(a$estimate) >= 0.2,"Korelasi >= 0,2",
                                   ifelse(abs(a$estimate) >= 0.1,"Korelasi >= 0,1","Korelasi Rendah"))))
  
  # Menentukan keputusan berdasarkan p-value
  decision <- ifelse(a$p.value < 0.05, "Signifikan 5 Persen", 
                     ifelse(a$p.value < 0.1,"Signifikan 10 Persen","Tidak Signifikan"))
  
  # Menambahkan hasil ke data frame
  results <- rbind(results, data.frame(Variable = names(data_olahan)[i],
                                       Correlation = a$estimate,
                                       Cutoff = as.factor(cutoff),
                                       P_Value = a$p.value,
                                       Decision = as.factor(decision)))
  
}

rownames(results) <- c(1:63)
print(results)
```


```{r}
summary(results)
```


```{r}
# EBLUP Disab dengan Package "msaeDB"
Disab <- data_olahan[,c(1,2,5,8:16,20:22,24,29:31,40,42,47,51:53,56:58,61,63)] %>%
  mutate(
    VarDir = ((APS_Disab/100)*RSE_Disab)^2,
    )

Disab <- na.omit(Disab)

# Model dengan semua variabel yang relevan
Eblup1 <- eblupFH(formula = APS_Disab ~
                              keluarga_listrik +
                              jumlah_menara_bts +
                              murid_sd +
                              murid_smp +
                              murid_sma +
                              murid_slb +
                              jumlah_sd +
                              jumlah_smp +
                              jumlah_sma +
                              desa_dalam_hutan +
                              desa_tepi_hutan +
                              desa_luar_hutan +
                              desa_ketinggian_kurang_200 +
                              keluarga_bukan_listrik +
                              jumlah_SKTM +
                              jumlah_sarana_kesehatan +
                              jumlah_desa_tidak_ada_ponsel +
                              jumlah_desa_lalu_lintas_lainnya +
                              jumlah_korban_bunuh_diri +
                              Persen_desa_dalam_hutan +
                              Persen_desa_tepi_hutan +
                              Persen_desa_luar_hutan +
                              Rasio_bts_luas +
                              Rasio_murid_sd +
                              Rasio_murid_smp +
                              Rasio_nakes_faskes +
                              Rasio_angkutan_umum_darat,
              vardir = VarDir,
              data = Disab)

Disab$VarDir <- as.numeric(Disab$VarDir)

Eblup$fit$estcoef     # estimasi paramter
Eblup$SAE_Eblup$yi    # hasil pendugaan tak langsung
Eblup$MSE_Eblup$yi    # MSE
Eblup$randomEffect$yi # rendomeffect

colnames(Disab)
```

